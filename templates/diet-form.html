<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diet Plan - HealthyPlate</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="bg-gray-100 font-sans">
  <!-- Navigation Bar -->
  <nav class="navbar navbar-dark bg-success sticky-top">
      <div class="container flex justify-between items-center py-2">
          <a class="navbar-brand text-2xl font-bold" href="{{ url_for('index') }}">HealthyPlate</a>
          <div class="navbar-nav flex items-center">
              <a class="nav-link text-white px-3 py-2 hover:bg-green-700 rounded" href="{{ url_for('index') }}">Home</a>
              <div class="dropdown">
                  <button class="btn text-white dropdown-toggle px-3 py-2 hover:bg-green-700 rounded" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                      <svg class="inline-block w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zm-4 7a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                      </svg>
                      <span id="username-display">User</span>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                      <li><a class="dropdown-item" href="#" onclick="logout()">Logout</a></li>
                  </ul>
              </div>
          </div>
      </div>
  </nav>

  <!-- Diet Recommendation Form -->
  <section id="diet-form" class="py-16">
      <div class="container mx-auto px-4">
          <h2 class="text-3xl font-bold text-center mb-12">Your Healthy Plate</h2>
          <div class="max-w-lg mx-auto bg-white p-8 rounded-lg shadow-md">
              <h3 class="text-xl font-semibold text-center mb-6 text-gray-800">Enter Your Details</h3>
              
              <div id="step-1" class="form-step active">
                  <div class="mb-4">
                      <label for="name" class="form-label text-gray-700">Name</label>
                      <input type="text" id="name" class="form-control" placeholder="Enter your name" required>
                  </div>
                  <button onclick="nextStep(1)" class="btn btn-success w-100">Next</button>
              </div>

              <div id="step-2" class="form-step">
                  <div class="mb-4">
                      <label for="age" class="form-label text-gray-700">Age (1-120 years)</label>
                      <input type="number" id="age" class="form-control" placeholder="Enter your age" min="1" max="120" required>
                  </div>
                  <button onclick="prevStep(2)" class="btn btn-secondary w-100 mb-2">Previous</button>
                  <button onclick="nextStep(2)" class="btn btn-success w-100">Next</button>
              </div>

              <div id="step-3" class="form-step">
                  <div class="mb-4">
                      <label for="gender" class="form-label text-gray-700">Gender</label>
                      <select id="gender" class="form-control" required>
                          <option value="" disabled selected>Select your gender</option>
                          <option value="male">Male</option>
                          <option value="female">Female</option>
                      </select>
                  </div>
                  <button onclick="prevStep(3)" class="btn btn-secondary w-100 mb-2">Previous</button>
                  <button onclick="nextStep(3)" class="btn btn-success w-100">Next</button>
              </div>

              <div id="step-4" class="form-step">
                  <div class="mb-4">
                      <label for="height-unit" class="form-label text-gray-700">Height Unit</label>
                      <select id="height-unit" class="form-control" onchange="toggleHeightInputs()" required>
                          <option value="cm" selected>Centimeters (cm)</option>
                          <option value="ft_in">Feet & Inches (ft, in)</option>
                      </select>
                  </div>
                  <div id="height-cm-group" class="mb-4">
                      <label for="height-cm" class="form-label text-gray-700">Height (50-250 cm)</label>
                      <input type="number" id="height-cm" class="form-control" placeholder="Enter height in cm" min="50" max="250" required>
                  </div>
                  <div id="height-ft-in-group" class="mb-4 hidden">
                      <label class="form-label text-gray-700">Height (ft, in)</label>
                      <div class="flex gap-2">
                          <input type="number" id="height-ft" class="form-control w-1/2" placeholder="Feet" min="1" max="8">
                          <input type="number" id="height-in" class="form-control w-1/2" placeholder="Inches" min="0" max="11">
                      </div>
                  </div>
                  <button onclick="prevStep(4)" class="btn btn-secondary w-100 mb-2">Previous</button>
                  <button onclick="nextStep(4)" class="btn btn-success w-100">Next</button>
              </div>

              <div id="step-5" class="form-step">
                  <div class="mb-4">
                      <label for="weight-unit" class="form-label text-gray-700">Weight Unit</label>
                      <select id="weight-unit" class="form-control" onchange="toggleWeightInputs()" required>
                          <option value="kg" selected>Kilograms (kg)</option>
                          <option value="lbs">Pounds (lbs)</option>
                      </select>
                  </div>
                  <div id="weight-kg-group" class="mb-4">
                      <label for="weight-kg" class="form-label text-gray-700">Weight (1-300 kg)</label>
                      <input type="number" id="weight-kg" class="form-control" placeholder="Enter weight in kg" min="1" max="300" required>
                  </div>
                  <div id="weight-lbs-group" class="mb-4 hidden">
                      <label for="weight-lbs" class="form-label text-gray-700">Weight (2-660 lbs)</label>
                      <input type="number" id="weight-lbs" class="form-control" placeholder="Enter weight in lbs" min="2" max="660">
                  </div>
                  <button onclick="prevStep(5)" class="btn btn-secondary w-100 mb-2">Previous</button>
                  <button onclick="nextStep(5)" class="btn btn-success w-100">Next</button>
              </div>

              <div id="step-6" class="form-step">
                  <div class="mb-4">
                      <label for="waist-size" class="form-label text-gray-700">Waist Size (50-200 cm)</label>
                      <input type="number" id="waist-size" class="form-control" placeholder="Enter waist size in cm" min="50" max="200" required>
                  </div>
                  <button onclick="prevStep(6)" class="btn btn-secondary w-100 mb-2">Previous</button>
                  <button onclick="nextStep(6)" class="btn btn-success w-100">Next</button>
              </div>

              <div id="step-7" class="form-step">
                  <div class="mb-4">
                      <label for="hip-size" class="form-label text-gray-700">Hip Size (60-200 cm)</label>
                      <input type="number" id="hip-size" class="form-control" placeholder="Enter hip size in cm" min="60" max="200" required>
                  </div>
                  <button onclick="prevStep(7)" class="btn btn-secondary w-100 mb-2">Previous</button>
                  <button onclick="nextStep(7)" class="btn btn-success w-100">Next</button>
              </div>

              <div id="step-8" class="form-step">
                  <div class="mb-4">
                      <label for="fitness-goal" class="form-label text-gray-700">Fitness Goal</label>
                      <select id="fitness-goal" class="form-control" required>
                          <option value="" disabled selected>Select your fitness goal</option>
                          <option value="weight_loss">Weight Loss</option>
                          <option value="muscle_gain">Muscle Gain</option>
                          <option value="maintenance">Maintain Health</option>
                          <option value="general_wellness">General Wellness</option>
                      </select>
                  </div>
                  <button onclick="prevStep(8)" class="btn btn-secondary w-100 mb-2">Previous</button>
                  <button onclick="nextStep(8)" class="btn btn-success w-100">Next</button>
              </div>

              <div id="step-9" class="form-step">
                  <div class="mb-4">
                      <label for="food-preference" class="form-label text-gray-700">Food Preference</label>
                      <select id="food-preference" class="form-control" required>
                          <option value="" disabled selected>Select your food preference</option>
                          <option value="vegetarian">Vegetarian</option>
                          <option value="vegan">Vegan</option>
                          <option value="non_vegetarian">Non-Vegetarian</option>
                          <option value="pescatarian">Pescatarian</option>
                          <option value="gluten_free">Gluten-Free</option>
                      </select>
                  </div>
                  <div class="mb-4">
                      <label for="activity-level" class="form-label text-gray-700">Activity Level</label>
                      <select id="activity-level" class="form-control" required>
                          <option value="" disabled selected>Select your activity level</option>
                          <option value="sedentary">Sedentary (little/no exercise)</option>
                          <option value="light">Light (light exercise 1-3 days/week)</option>
                          <option value="moderate">Moderate (moderate exercise 3-5 days/week)</option>
                          <option value="active">Active (hard exercise 6-7 days/week)</option>
                          <option value="very_active">Very Active (very hard exercise, physical job)</option>
                      </select>
                  </div>
                  <button onclick="prevStep(9)" class="btn btn-secondary w-100 mb-2">Previous</button>
                  <button onclick="submitHealthPlate()" class="btn btn-success w-100">Get My Diet Plan</button>
              </div>
          </div>
      </div>
  </section>

  <!-- Results Section -->
  <section id="results" class="py-16 bg-gray-200" style="display: none;">
      <div class="container mx-auto px-4">
          <h2 class="text-3xl font-bold text-center mb-12">Your Personalized Diet Plan</h2>
          <div class="max-w-6xl mx-auto">
              <div class="bg-white p-8 rounded-lg shadow-md mb-6">
                  <h3 class="text-xl font-semibold mb-4 text-success">Health Analysis</h3>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div class="bg-light p-4 rounded">
                          <p class="mb-1"><strong>BMI:</strong></p>
                          <p class="text-2xl font-bold text-success" id="result-bmi"></p>
                      </div>
                      <div class="bg-light p-4 rounded">
                          <p class="mb-1"><strong>Body Type:</strong></p>
                          <p class="text-lg font-semibold text-primary" id="result-body-type"></p>
                      </div>
                  </div>
              </div>
              
              <div class="bg-white p-8 rounded-lg shadow-md">
                  <h3 class="text-xl font-semibold mb-4 text-success">Your Personalized Nutrition Plan</h3>
                  <p class="text-muted mb-4">Based on real nutrition data and your personal characteristics</p>
                  <div id="diet-plan-content"></div>
                  <div class="mt-6 text-center flex flex-col sm:flex-row justify-center gap-3">
                      <button id="download-pdf-btn" class="btn btn-success btn-lg px-5" onclick="downloadDietPlan()">
                          <i class="fas fa-download me-2"></i>Download Diet Plan</button>
                      
                  </div>
              </div>
          </div>
      </div>
  </section>

  <!-- Footer -->
  <footer class="bg-success text-white py-4">
      <div class="container mx-auto text-center">
          <p>© 2025 Design by Satkar Shrestha and Sandhya Gharti. All rights reserved.</p>
      </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
      // Global variables
      let currentStep = 1;
      let currentResultId = null;

      // Show alert message (utility function)
      function showAlert(message, type) {
          const existingAlerts = document.querySelectorAll(".alert");
          existingAlerts.forEach((alert) => alert.remove());

          const alertDiv = document.createElement("div");
          alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
          alertDiv.style.top = "20px";
          alertDiv.style.right = "20px";
          alertDiv.style.zIndex = "9999";
          alertDiv.style.minWidth = "300px";

          alertDiv.innerHTML = `
              ${message}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          document.body.appendChild(alertDiv);

          setTimeout(() => {
              if (alertDiv.parentNode) {
                  alertDiv.remove();
              }
          }, 5000);
      }

      // Logout function (common action)
      function logout() {
          if (confirm("Are you sure you want to logout?")) {
              fetch("/api/logout", {
                  method: "POST",
              })
              .then((response) => response.json())
              .then((data) => {
                  if (data.success) {
                      window.location.href = "/";
                  }
              })
              .catch((error) => {
                  console.error("Logout error:", error);
                  window.location.href = "/";
              });
          }
      }

      // Check authentication on page load
      document.addEventListener("DOMContentLoaded", () => {
          checkAuth();
          toggleHeightInputs(); // Initialize height inputs based on default selection
          toggleWeightInputs(); // Initialize weight inputs based on default selection
      });

      // Check if user is authenticated (specific to diet form dashboard)
      function checkAuth() {
          fetch("/api/auth-status")
              .then((response) => response.json())
              .then((data) => {
                  if (!data.authenticated || data.user_type !== "user") {
                      window.location.href = "/"; // Redirect to index if not authenticated as user
                  } else {
                      document.getElementById("username-display").textContent = data.user.first_name || data.user.username;
                  }
              })
              .catch((error) => {
                  console.error("Auth check failed:", error);
                  window.location.href = "/"; // Redirect on error
              });
      }

      // Toggle height input fields based on unit selection
      function toggleHeightInputs() {
          const unit = document.getElementById("height-unit").value;
          document.getElementById("height-cm-group").classList.toggle("hidden", unit !== "cm");
          document.getElementById("height-ft-in-group").classList.toggle("hidden", unit !== "ft_in");

          // Set required attributes based on active group
          document.getElementById("height-cm").required = (unit === "cm");
          document.getElementById("height-ft").required = (unit === "ft_in");
          document.getElementById("height-in").required = (unit === "ft_in");
      }

      // Toggle weight input fields based on unit selection
      function toggleWeightInputs() {
          const unit = document.getElementById("weight-unit").value;
          document.getElementById("weight-kg-group").classList.toggle("hidden", unit !== "kg");
          document.getElementById("weight-lbs-group").classList.toggle("hidden", unit !== "lbs");

          // Set required attributes based on active group
          document.getElementById("weight-kg").required = (unit === "kg");
          document.getElementById("weight-lbs").required = (unit === "lbs");
      }

      // Form navigation functions
      function nextStep(step) {
          // Validate current step
          let isValid = true;
          const currentStepElement = document.getElementById(`step-${step}`);
          const requiredFields = currentStepElement.querySelectorAll("[required]");

          requiredFields.forEach(field => {
              if (field.classList.contains('hidden')) { // Skip validation for hidden fields (e.g., inactive unit inputs)
                  return;
              }
              if (!field.value) {
                  isValid = false;
                  showAlert("Please fill out all required fields.", "danger");
                  return;
              }
          });

          if (!isValid) {
              return;
          }

          // Additional validation for specific steps
          if (step === 2) {
              const age = Number.parseInt(document.getElementById("age").value);
              if (age < 1 || age > 120) {
                  showAlert("Age must be between 1 and 120 years.", "danger");
                  return;
              }
          }

          if (step === 4) {
              const heightUnit = document.getElementById("height-unit").value;
              let heightValue;
              if (heightUnit === 'cm') {
                  heightValue = Number.parseInt(document.getElementById("height-cm").value);
                  if (heightValue < 50 || heightValue > 250) {
                      showAlert("Height (cm) must be between 50 and 250 cm.", "danger");
                      return;
                  }
              } else { // ft_in
                  const feet = Number.parseInt(document.getElementById("height-ft").value);
                  const inches = Number.parseInt(document.getElementById("height-in").value);
                  if (feet < 1 || feet > 8 || inches < 0 || inches > 11 || isNaN(feet) || isNaN(inches)) {
                      showAlert("Please enter valid feet (1-8) and inches (0-11) for height.", "danger");
                      return;
                  }
              }
          }

          if (step === 5) {
              const weightUnit = document.getElementById("weight-unit").value;
              let weightValue;
              if (weightUnit === 'kg') {
                  weightValue = Number.parseInt(document.getElementById("weight-kg").value);
                  if (weightValue < 1 || weightValue > 300) {
                      showAlert("Weight (kg) must be between 1 and 300 kg.", "danger");
                      return;
                  }
              } else { // lbs
                  weightValue = Number.parseInt(document.getElementById("weight-lbs").value);
                  if (weightValue < 2 || weightValue > 660) { // Approx 1kg to 300kg in lbs
                      showAlert("Weight (lbs) must be between 2 and 660 lbs.", "danger");
                      return;
                  }
              }
          }

          if (step === 6) {
              const waistSize = Number.parseInt(document.getElementById("waist-size").value);
              if (waistSize < 50 || waistSize > 200) {
                  showAlert("Waist size must be between 50 and 200 cm.", "danger");
                  return;
              }
          }

          if (step === 7) {
              const hipSize = Number.parseInt(document.getElementById("hip-size").value);
              if (hipSize < 60 || hipSize > 200) {
                  showAlert("Hip size must be between 60 and 200 cm.", "danger");
                  return;
              }
          }

          // Hide current step, show next
          document.getElementById(`step-${step}`).classList.remove("active");
          currentStep = step + 1;
          document.getElementById(`step-${currentStep}`).classList.add("active");
      }

      function prevStep(step) {
          // Hide current step, show previous
          document.getElementById(`step-${step}`).classList.remove("active");
          currentStep = step - 1;
          document.getElementById(`step-${currentStep}`).classList.add("active");
      }

      // Submit health plate form
      function submitHealthPlate() {
          // Validate final step
          const foodPreference = document.getElementById("food-preference").value;
          const activityLevel = document.getElementById("activity-level").value;

          if (!foodPreference || !activityLevel) {
              showAlert("Please fill out all fields.", "danger");
              return;
          }

          // Collect all data
          const formData = {
              name: document.getElementById("name").value,
              age: Number.parseInt(document.getElementById("age").value),
              gender: document.getElementById("gender").value,
              waist_size: Number.parseInt(document.getElementById("waist-size").value),
              hip_size: Number.parseInt(document.getElementById("hip-size").value),
              fitness_goal: document.getElementById("fitness-goal").value,
              food_preference: foodPreference,
              activity_level: activityLevel,
          };

          // Add height based on unit
          const heightUnit = document.getElementById("height-unit").value;
          formData.height_unit = heightUnit;
          if (heightUnit === 'cm') {
              formData.height = Number.parseInt(document.getElementById("height-cm").value);
          } else {
              formData.height_ft = Number.parseInt(document.getElementById("height-ft").value);
              formData.height_in = Number.parseInt(document.getElementById("height-in").value);
          }

          // Add weight based on unit
          const weightUnit = document.getElementById("weight-unit").value;
          formData.weight_unit = weightUnit;
          if (weightUnit === 'kg') {
              formData.weight = Number.parseInt(document.getElementById("weight-kg").value);
          } else {
              formData.weight = Number.parseInt(document.getElementById("weight-lbs").value);
          }

          // Show loading
          const submitBtn = document.querySelector("#step-9 .btn-success");
          const originalText = submitBtn.textContent;
          submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
          submitBtn.disabled = true;

          // Submit to API
          fetch("/api/diet-recommendation", {
              method: "POST",
              headers: {
                  "Content-Type": "application/json",
              },
              body: JSON.stringify(formData),
          })
          .then((response) => response.json())
          .then((data) => {
              if (data.success) {
                  currentResultId = data.result_id;
                  displayResults(data);
                  resetForm();
              } else {
                  showAlert(data.message, "danger");
              }
          })
          .catch((error) => {
              showAlert("An error occurred. Please try again.", "danger");
          })
          .finally(() => {
              submitBtn.textContent = originalText;
              submitBtn.disabled = false;
          });
      }

      // Display results
      function displayResults(data) {
          // Update result fields
          document.getElementById("result-bmi").textContent = data.bmi;
          document.getElementById("result-body-type").textContent = data.body_type;
          // Model accuracy is no longer displayed

          // Display nutritional targets
          const nutritionInfo = `
              <div class="row mb-4">
                  <div class="col-12">
                      <h4 class="text-success mb-3">Daily Nutritional Targets</h4>
                  </div>
                  <div class="col-md-4">
                      <div class="bg-light p-3 rounded mb-2 nutrition-target">
                          <strong>Calories:</strong> ${data.diet_plan.daily_calories} kcal
                      </div>
                      <div class="bg-light p-3 rounded mb-2 nutrition-target">
                          <strong>Protein:</strong> ${data.diet_plan.protein}g
                      </div>
                  </div>
                  <div class="col-md-4">
                      <div class="bg-light p-3 rounded mb-2 nutrition-target">
                          <strong>Carbohydrates:</strong> ${data.diet_plan.carbohydrates}g
                      </div>
                      <div class="bg-light p-3 rounded mb-2 nutrition-target">
                          <strong>Fat:</strong> ${data.diet_plan.fat}g
                      </div>
                  </div>
                  <div class="col-md-4">
                      <div class="bg-light p-3 rounded mb-2 nutrition-target">
                          <strong>Fiber:</strong> ${data.diet_plan.fiber}g
                      </div>
                      <div class="bg-light p-3 rounded mb-2 nutrition-target">
                          <strong>Sugar:</strong> ${data.diet_plan.sugar}g
                      </div>
                      <div class="bg-light p-3 rounded mb-2 nutrition-target">
                          <strong>Sodium:</strong> ${data.diet_plan.sodium}mg
                      </div>
                  </div>
              </div>
          `;

          // Display diet plan
          const dietPlanContent = document.getElementById("diet-plan-content");
          dietPlanContent.innerHTML = nutritionInfo;

          const meals = {
              Breakfast: data.diet_plan.breakfast,
              Lunch: data.diet_plan.lunch,
              Dinner: data.diet_plan.dinner,
              Snack: data.diet_plan.snack,
          };

          for (const [meal, description] of Object.entries(meals)) {
              const mealDiv = document.createElement("div");
              mealDiv.className = "mb-3 p-4 bg-light rounded meal-card";
              mealDiv.innerHTML = `
                  <h5 class="text-success mb-2">${meal}</h5>
                  <p class="mb-0 text-dark">${description}</p>
              `;
              dietPlanContent.appendChild(mealDiv);
          }

          // Show results section
          document.getElementById("results").style.display = "block";
          document.getElementById("results").scrollIntoView({ behavior: "smooth" });

          
      }

      // Download diet plan as PDF
      function downloadDietPlan() {
          if (!currentResultId) {
              showAlert("No diet plan available to download.", "danger");
              return;
          }

          window.open(`/api/download-diet-plan/${currentResultId}`, "_blank");
      }

     

      // Reset form
      function resetForm() {
          // Clear all form fields
          document.getElementById("name").value = "";
          document.getElementById("age").value = "";
          document.getElementById("gender").value = "";
          document.getElementById("height-cm").value = "";
          document.getElementById("height-ft").value = "";
          document.getElementById("height-in").value = "";
          document.getElementById("weight-kg").value = "";
          document.getElementById("weight-lbs").value = "";
          document.getElementById("waist-size").value = "";
          document.getElementById("hip-size").value = "";
          document.getElementById("fitness-goal").value = "";
          document.getElementById("food-preference").value = "";
          document.getElementById("activity-level").value = "";

          // Reset to first step
          document.getElementById(`step-${currentStep}`).classList.remove("active");
          currentStep = 1;
          document.getElementById("step-1").classList.add("active");
          
          // Reset unit selections to default
          document.getElementById("height-unit").value = "cm";
          document.getElementById("weight-unit").value = "kg";
          toggleHeightInputs();
          toggleWeightInputs();
      }
  </script>
</body>
</html>
