<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Profile - HealthyPlate</title>
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="bg-gray-100 font-sans">
<!-- Navigation Bar -->
<nav class="navbar navbar-dark bg-success sticky-top">
    <div class="container flex justify-between items-center py-2">
        <a class="navbar-brand text-2xl font-bold" href="{{ url_for('index') }}">HealthyPlate</a>
        <div class="navbar-nav flex items-center">
            <a class="nav-link text-white px-3 py-2 hover:bg-green-700 rounded" href="{{ url_for('index') }}">Home</a>
            <a class="nav-link text-white px-3 py-2 hover:bg-green-700 rounded" href="{{ url_for('index') }}#about">About</a>
            <a class="nav-link text-white px-3 py-2 hover:bg-green-700 rounded" href="{{ url_for('diet_form_page') }}">Diet Plan</a>
            <div class="dropdown">
                <button class="btn text-white dropdown-toggle px-3 py-2 hover:bg-green-700 rounded" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <svg class="inline-block w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zm-4 7a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span id="username-display">User</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                    <li><a class="dropdown-item" href="#">Welcome, <span id="username-display-dropdown">User</span></a></li>
                    <li><a class="dropdown-item" href="{{ url_for('profile_page') }}">Profile</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="logout()">Logout</a></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<!-- User Profile Section -->
<section id="user-profile" class="py-16">
    <div class="container mx-auto px-4">
        <h2 class="text-3xl font-bold text-center mb-12">Manage Your Profile</h2>
        <div class="max-w-lg mx-auto bg-white p-8 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold text-center mb-6 text-gray-800">Edit Profile Details</h3>
            <div class="mb-4">
                <label for="profile-username" class="form-label text-gray-700">Username</label>
                <input type="text" id="profile-username" class="form-control" placeholder="Enter username" required>
            </div>
            <div class="mb-4">
                <label for="profile-email" class="form-label text-gray-700">Email</label>
                <input type="email" id="profile-email" class="form-control" placeholder="Enter email" required>
            </div>
            <div class="mb-4">
                <label for="profile-first-name" class="form-label text-gray-700">First Name</label>
                <input type="text" id="profile-first-name" class="form-control" placeholder="Enter first name" required>
            </div>
            <div class="mb-4">
                <label for="profile-last-name" class="form-label text-gray-700">Last Name</label>
                <input type="text" id="profile-last-name" class="form-control" placeholder="Enter last name" required>
            </div>
            <div class="mb-4">
                <label for="profile-password" class="form-label text-gray-700">New Password (Leave blank to keep current)</label>
                <input type="password" id="profile-password" class="form-control" placeholder="Enter new password">
            </div>
            <button onclick="saveUserProfile()" class="btn btn-success w-100">Save Changes</button>
        </div>
    </div>
</section>

<!-- Footer -->
<footer class="bg-success text-white py-4">
    <div class="container mx-auto text-center">
        <p>Â© 2025 Design by Satkar Shrestha and Sandhya Gharti. All rights reserved.</p>
    </div>
</footer>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Show alert message (utility function)
    function showAlert(message, type) {
        const existingAlerts = document.querySelectorAll(".alert");
        existingAlerts.forEach((alert) => alert.remove());

        const alertDiv = document.createElement("div");
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.top = "20px";
        alertDiv.style.right = "20px";
        alertDiv.style.zIndex = "9999";
        alertDiv.style.minWidth = "300px";

        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);

        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Logout function (common action)
    function logout() {
        if (confirm("Are you sure you want to logout?")) {
            fetch("/api/logout", {
                method: "POST",
            })
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    window.location.href = "/";
                }
            })
            .catch((error) => {
                console.error("Logout error:", error);
                window.location.href = "/";
            });
        }
    }

    // Check authentication and load user profile on page load
    document.addEventListener("DOMContentLoaded", () => {
        checkAuthAndLoadProfile();
    });

    // Check if user is authenticated and load profile data
    function checkAuthAndLoadProfile() {
        fetch("/api/auth-status")
            .then((response) => response.json())
            .then((data) => {
                if (!data.authenticated || data.user_type !== "user") {
                    window.location.href = "/"; // Redirect to index if not authenticated as user
                } else {
                    // Populate navigation username
                    document.getElementById("username-display").textContent = data.user.first_name || data.user.username;
                    document.getElementById("username-display-dropdown").textContent = data.user.first_name || data.user.username;

                    // Populate profile form fields
                    document.getElementById("profile-username").value = data.user.username;
                    document.getElementById("profile-email").value = data.user.email;
                    document.getElementById("profile-first-name").value = data.user.first_name;
                    document.getElementById("profile-last-name").value = data.user.last_name;
                }
            })
            .catch((error) => {
                console.error("Auth check failed:", error);
                window.location.href = "/"; // Redirect on error
            });
    }

    // Save user profile changes
    function saveUserProfile() {
        const username = document.getElementById("profile-username").value;
        const email = document.getElementById("profile-email").value;
        const firstName = document.getElementById("profile-first-name").value;
        const lastName = document.getElementById("profile-last-name").value;
        const password = document.getElementById("profile-password").value;

        if (!username || !email || !firstName || !lastName) {
            showAlert("Please fill out all required fields.", "danger");
            return;
        }

        const userData = {
            username: username,
            email: email,
            first_name: firstName,
            last_name: lastName,
        };
        if (password) { // Only include password if provided
            if (password.length < 6) {
                showAlert("New password must be at least 6 characters long.", "danger");
                return;
            }
            userData.password = password;
        }

        fetch("/api/user/profile", {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(userData),
        })
        .then((response) => response.json())
        .then((data) => {
            if (data.success) {
                showAlert(data.message, "success");
                // Re-fetch profile data to update displayed username in nav if it changed
                checkAuthAndLoadProfile(); 
                // Clear password field after successful update
                document.getElementById("profile-password").value = "";
            } else {
                showAlert(data.message, "danger");
            }
        })
        .catch((error) => {
            console.error("Error saving profile:", error);
            showAlert("An error occurred. Please try again.", "danger");
        });
    }
</script>
</body>
</html>
