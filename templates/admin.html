<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - HealthyPlate</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="bg-gray-100 font-sans">
  <!-- Navigation Bar -->
  <nav class="navbar navbar-dark bg-success sticky-top">
      <div class="container flex justify-between items-center py-2">
          <a class="navbar-brand text-2xl font-bold" href="{{ url_for('index') }}">HealthyPlate Admin</a>
          <div class="navbar-nav flex items-center">
              <a class="nav-link text-white px-3 py-2 hover:bg-green-700 rounded" href="#users">Users</a>
              <a class="nav-link text-white px-3 py-2 hover:bg-green-700 rounded" href="#diet-results">Diet Results</a>
              <div class="dropdown" id="userDropdown">
                  <button class="btn text-white px-3 py-2 hover:bg-green-700 rounded" type="button" id="userDropdownButton" data-bs-toggle="dropdown" aria-expanded="false">
                      <svg class="inline-block w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zm-4 7a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                      </svg>
                      Admin
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdownButton">
                      <li><a class="dropdown-item" href="#" onclick="logout()">Logout</a></li>
                  </ul>
              </div>
          </div>
      </div>
  </nav>

  <!-- Users Section -->
  <section id="users" class="py-16">
      <div class="container mx-auto px-4">
          <h2 class="text-3xl font-bold text-center mb-12">Manage Users</h2>
          <!-- Add/Edit User Form -->
          <div class="max-w-lg mx-auto bg-white p-8 rounded-lg shadow-md mb-8">
              <h3 id="user-form-title" class="text-xl font-semibold text-center mb-6 text-gray-800">Add New User</h3>
              <input type="hidden" id="user-id">
              <div class="mb-4">
                  <label for="user-username" class="form-label text-gray-700">Username</label>
                  <input type="text" id="user-username" class="form-control" placeholder="Enter username" required>
              </div>
              <div class="mb-4">
                  <label for="user-email" class="form-label text-gray-700">Email</label>
                  <input type="email" id="user-email" class="form-control" placeholder="Enter email" required>
              </div>
              <div class="mb-4">
                  <label for="user-first-name" class="form-label text-gray-700">First Name</label>
                  <input type="text" id="user-first-name" class="form-control" placeholder="Enter first name" required>
              </div>
              <div class="mb-4">
                  <label for="user-last-name" class="form-label text-gray-700">Last Name</label>
                  <input type="text" id="user-last-name" class="form-control" placeholder="Enter last name" required>
              </div>
              <div class="mb-4">
                  <label for="user-password" class="form-label text-gray-700">Password (Leave blank to keep current)</label>
                  <input type="password" id="user-password" class="form-control" placeholder="Enter password">
              </div>
              <button onclick="saveUser()" class="btn btn-success w-100">Save User</button>
              <button onclick="resetUserForm()" class="btn btn-secondary w-100 mt-2 hidden" id="cancel-edit-user">Cancel Edit</button>
          </div>
          <!-- Users Table -->
          <div class="bg-white p-6 rounded-lg shadow-md">
              <h3 class="text-xl font-semibold mb-4 text-gray-800">Users List</h3>
              <div class="table-responsive">
                  <table class="table table-striped">
                      <thead>
                          <tr>
                              <th>ID</th>
                              <th>Username</th>
                              <th>Email</th>
                              <th>First Name</th>
                              <th>Last Name</th>
                              <th>Registration Date</th>
                              <th>Actions</th>
                          </tr>
                      </thead>
                      <tbody id="users-table-body"></tbody>
                  </table>
              </div>
          </div>
      </div>
  </section>

  <!-- Diet Results Section -->
  <section id="diet-results" class="py-16 bg-gray-200">
      <div class="container mx-auto px-4">
          <h2 class="text-3xl font-bold text-center mb-12">User Diet Results</h2>
          <div class="bg-white p-6 rounded-lg shadow-md">
              <h3 class="text-xl font-semibold mb-4 text-gray-800">Diet Results List</h3>
              <div class="table-responsive">
                  <table class="table table-striped">
                      <thead>
                          <tr>
                              <th>ID</th>
                              <th>User</th>
                              <th>Name</th>
                              <th>Age</th>
                              <th>BMI</th>
                              <th>Body Type</th>
                              <th>Fitness Goal</th>
                              <th>Date</th>
                              <th>Actions</th>
                          </tr>
                      </thead>
                      <tbody id="diet-results-table-body"></tbody>
                  </table>
              </div>
          </div>
      </div>
  </section>

  <!-- Footer -->
  <footer class="bg-success text-white py-4">
      <div class="container mx-auto text-center">
          <p>Â© 2025 Design by Satkar Shrestha and Sandhya Gharti. All rights reserved.</p>
      </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
      // Global variables
      let users = [];
      let dietResults = [];
      let editingUserId = null;

      // Show alert message (utility function)
      function showAlert(message, type) {
          const existingAlerts = document.querySelectorAll(".alert");
          existingAlerts.forEach((alert) => alert.remove());

          const alertDiv = document.createElement("div");
          alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
          alertDiv.style.top = "20px";
          alertDiv.style.right = "20px";
          alertDiv.style.zIndex = "9999";
          alertDiv.style.minWidth = "300px";

          alertDiv.innerHTML = `
              ${message}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          document.body.appendChild(alertDiv);

          setTimeout(() => {
              if (alertDiv.parentNode) {
                  alertDiv.remove();
              }
          }, 5000);
      }

      // Logout function (common action)
      function logout() {
          if (confirm("Are you sure you want to logout?")) {
              fetch("/api/logout", {
                  method: "POST",
              })
              .then((response) => response.json())
              .then((data) => {
                  if (data.success) {
                      window.location.href = "/";
                  }
              })
              .catch((error) => {
                  console.error("Logout error:", error);
                  window.location.href = "/";
              });
          }
      }

      // Check authentication on page load
      document.addEventListener("DOMContentLoaded", () => {
          checkAuth();
          loadData();
      });

      // Check if admin is authenticated (specific to admin dashboard)
      function checkAuth() {
          fetch("/api/auth-status")
              .then((response) => response.json())
              .then((data) => {
                  if (!data.authenticated || data.user_type !== "admin") {
                      window.location.href = "/"; // Redirect to index if not authenticated as admin
                  }
              })
              .catch((error) => {
                  console.error("Auth check failed:", error);
                  window.location.href = "/"; // Redirect on error
              });
      }

      // Load all data
      function loadData() {
          loadUsers();
          loadDietResults();
      }

      // Load users
      function loadUsers() {
          fetch("/api/admin/users")
              .then((response) => response.json())
              .then((data) => {
                  if (data.success) {
                      users = data.users;
                      renderUsers();
                  } else {
                      showAlert(data.message, "danger");
                  }
              })
              .catch((error) => {
                  console.error("Error loading users:", error);
                  showAlert("An error occurred. Please try again.", "danger");
              });
      }

      // Load diet results
      function loadDietResults() {
          fetch("/api/admin/diet-results")
              .then((response) => response.json())
              .then((data) => {
                  if (data.success) {
                      dietResults = data.results;
                      renderDietResults();
                  } else {
                      showAlert(data.message, "danger");
                  }
              })
              .catch((error) => {
                  console.error("Error loading diet results:", error);
                  showAlert("An error occurred. Please try again.", "danger");
              });
      }

      // Render users table
      function renderUsers() {
          const tbody = document.getElementById("users-table-body");
          tbody.innerHTML = "";

          users.forEach((user) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                  <td>${user.id}</td>
                  <td>${user.username}</td>
                  <td>${user.email}</td>
                  <td>${user.first_name}</td>
                  <td>${user.last_name}</td>
                  <td>${new Date(user.created_at).toLocaleDateString()}</td>
                  <td>
                      <button class="btn btn-primary btn-sm me-1" onclick="editUser(${user.id})">Edit</button>
                      <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">Delete</button>
                  </td>
              `;
              tbody.appendChild(row);
          });
      }

      // Render diet results table
      function renderDietResults() {
          const tbody = document.getElementById("diet-results-table-body");
          tbody.innerHTML = "";

          dietResults.forEach((result) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                  <td>${result.id}</td>
                  <td>${result.username}</td>
                  <td>${result.name}</td>
                  <td>${result.age}</td>
                  <td>${result.bmi}</td>
                  <td>${result.body_type}</td>
                  <td>${result.fitness_goal.replace("_", " ")}</td>
                  <td>${new Date(result.created_at).toLocaleDateString()}</td>
                  <td>
                      <button class="btn btn-info btn-sm me-1" onclick="viewDietResult(${result.id})">View</button>
                      <button class="btn btn-danger btn-sm" onclick="deleteDietResult(${result.id})">Delete</button>
                  </td>
              `;
              tbody.appendChild(row);
          });
      }

      // Save user (Add/Edit)
      function saveUser() {
          const username = document.getElementById("user-username").value;
          const email = document.getElementById("user-email").value;
          const firstName = document.getElementById("user-first-name").value;
          const lastName = document.getElementById("user-last-name").value;
          const password = document.getElementById("user-password").value;

          if (!username || !email || !firstName || !lastName) {
              showAlert("Please fill out all required fields.", "danger");
              return;
          }

          if (!editingUserId && !password) { // Password is required for new users
              showAlert("Password is required for new users.", "danger");
              return;
          }

          const userData = {
              username: username,
              email: email,
              first_name: firstName,
              last_name: lastName,
          };
          if (password) { // Only include password if provided (for new or updated)
              userData.password = password;
          }

          const url = editingUserId ? `/api/admin/users/${editingUserId}` : "/api/admin/users";
          const method = editingUserId ? "PUT" : "POST";

          fetch(url, {
              method: method,
              headers: {
                  "Content-Type": "application/json",
              },
              body: JSON.stringify(userData),
          })
          .then((response) => response.json())
          .then((data) => {
              if (data.success) {
                  showAlert(data.message, "success");
                  resetUserForm();
                  loadUsers();
              } else {
                  showAlert(data.message, "danger");
              }
          })
          .catch((error) => {
              console.error("Error saving user:", error);
              showAlert("An error occurred. Please try again.", "danger");
          });
      }

      // Edit user
      function editUser(id) {
          const user = users.find((u) => u.id === id);
          if (user) {
              editingUserId = id;
              document.getElementById("user-username").value = user.username;
              document.getElementById("user-email").value = user.email;
              document.getElementById("user-first-name").value = user.first_name;
              document.getElementById("user-last-name").value = user.last_name;
              document.getElementById("user-password").value = ""; // Clear password field for security
              document.getElementById("user-form-title").textContent = "Edit User";
              document.getElementById("cancel-edit-user").classList.remove("hidden");
          }
      }

      // Reset user form
      function resetUserForm() {
          editingUserId = null;
          document.getElementById("user-username").value = "";
          document.getElementById("user-email").value = "";
          document.getElementById("user-first-name").value = "";
          document.getElementById("user-last-name").value = "";
          document.getElementById("user-password").value = "";
          document.getElementById("user-form-title").textContent = "Add New User";
          document.getElementById("cancel-edit-user").classList.add("hidden");
      }

      // Delete user
      function deleteUser(id) {
          if (confirm("Are you sure you want to delete this user? This will also delete all their diet results.")) {
              fetch(`/api/admin/users/${id}`, {
                  method: "DELETE",
              })
              .then((response) => response.json())
              .then((data) => {
                  if (data.success) {
                      showAlert(data.message, "success");
                      loadUsers();
                      loadDietResults();
                  } else {
                      showAlert(data.message, "danger");
                  }
              })
              .catch((error) => {
                  console.error("Error deleting user:", error);
                  showAlert("An error occurred. Please try again.", "danger");
              });
          }
      }

      // View diet result
      function viewDietResult(id) {
          const result = dietResults.find((r) => r.id === id);
          if (result) {
              const details = `
Diet Result Details:

User: ${result.username} (${result.email})
Name: ${result.name}
Age: ${result.age} years
Gender: ${result.gender}
Height: ${result.height}cm
Weight: ${result.weight}kg
BMI: ${result.bmi}
Body Type: ${result.body_type}
Fitness Goal: ${result.fitness_goal.replace("_", " ")}
Food Preference: ${result.food_preference.replace("_", " ")}

Daily Nutritional Targets:
Calories: ${result.daily_calories} kcal
Protein: ${result.protein}g
Carbohydrates: ${result.carbs}g
Fat: ${result.fat}g
Fiber: ${result.fiber}g
Sugar: ${result.sugar}g
Sodium: ${result.sodium}mg

Personalized Diet Plan:
Breakfast: ${result.breakfast}
Lunch: ${result.lunch}
Dinner: ${result.dinner}
Snack: ${result.snack}

Generated: ${new Date(result.created_at).toLocaleDateString()}
              `;
              alert(details);
          }
      }

      // Delete diet result
      function deleteDietResult(id) {
          if (confirm("Are you sure you want to delete this diet result?")) {
              fetch(`/api/admin/diet-results/${id}`, {
                  method: "DELETE",
              })
              .then((response) => response.json())
              .then((data) => {
                  if (data.success) {
                      showAlert(data.message, "success");
                      loadDietResults();
                  } else {
                      showAlert(data.message, "danger");
                  }
              })
              .catch((error) => {
                  console.error("Error deleting diet result:", error);
                  showAlert("An error occurred. Please try again.", "danger");
              });
          }
      }
  </script>
</body>
</html>
