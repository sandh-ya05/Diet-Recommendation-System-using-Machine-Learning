<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Diet History - HealthyPlate</title>
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="bg-gray-100 font-sans">
<!-- Navigation Bar -->
<nav class="navbar navbar-dark bg-success sticky-top">
    <div class="container flex justify-between items-center py-2">
        <a class="navbar-brand text-2xl font-bold" href="{{ url_for('index') }}">HealthyPlate</a>
        <div class="navbar-nav flex items-center">
            <a class="nav-link text-white px-3 py-2 hover:bg-green-700 rounded" href="{{ url_for('index') }}">Home</a>
            <a class="nav-link text-white px-3 py-2 hover:bg-green-700 rounded" href="{{ url_for('diet_form_page') }}">Diet Plan</a>
            <a class="nav-link text-white px-3 py-2 hover:bg-green-700 rounded" href="{{ url_for('diet_history_page') }}">Diet History</a>
            <div class="dropdown">
                <button class="btn text-white dropdown-toggle px-3 py-2 hover:bg-green-700 rounded" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <svg class="inline-block w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zm-4 7a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span id="username-display">User</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                    <li><a class="dropdown-item" href="#">Welcome, <span id="username-display-dropdown">User</span></a></li>
                    <li><a class="dropdown-item" href="{{ url_for('profile_page') }}">Profile</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="logout()">Logout</a></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<!-- Diet History Section -->
<section id="diet-history" class="py-16 bg-gray-100">
    <div class="container mx-auto px-4">
        <h2 class="text-3xl font-bold text-center mb-12">Your Past Diet Plans</h2>
        
        {% if diet_history %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for plan in diet_history %}
                <div class="bg-white p-6 rounded-lg shadow-md border-left">
                    <h3 class="text-xl font-semibold text-success mb-3">Plan for {{ plan.name }} ({{ plan.created_at.split(' ')[0] }})</h3>
                    <div class="mb-4 text-sm text-gray-700">
                        <p><strong>Age:</strong> {{ plan.age }}</p>
                        <p><strong>Gender:</strong> {{ plan.gender.title() }}</p>
                        <p><strong>Height:</strong> {{ plan.height }} cm</p>
                        <p><strong>Weight:</strong> {{ plan.weight }} kg</p>
                        <p><strong>BMI:</strong> {{ plan.bmi }} ({{ plan.body_type }})</p>
                        <p><strong>Fitness Goal:</strong> {{ plan.fitness_goal.replace('_', ' ').title() }}</p>
                        <p><strong>Food Preference:</strong> {{ plan.food_preference.replace('_', ' ').title() }}</p>
                        <p><strong>Activity Level:</strong> {{ plan.activity_level.replace('_', ' ').title() }}</p>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Nutritional Targets:</h4>
                    <ul class="list-unstyled text-sm text-gray-700 mb-4">
                        <li><strong>Calories:</strong> {{ plan.daily_calorie_target }} kcal</li>
                        <li><strong>Protein:</strong> {{ plan.protein_target }} g</li>
                        <li><strong>Carbs:</strong> {{ plan.carbs_target }} g</li>
                        <li><strong>Fat:</strong> {{ plan.fat_target }} g</li>
                        <li><strong>Fiber:</strong> {{ plan.fiber_target }} g</li>
                        <li><strong>Sugar:</strong> {{ plan.sugar_target }} g</li>
                        <li><strong>Sodium:</strong> {{ plan.sodium_target }} mg</li>
                    </ul>
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Meal Plan:</h4>
                    <ul class="list-unstyled text-sm text-gray-700">
                        <li><strong>Breakfast:</strong> {{ plan.breakfast }}</li>
                        <li><strong>Lunch:</strong> {{ plan.lunch }}</li>
                        <li><strong>Dinner:</strong> {{ plan.dinner }}</li>
                        <li><strong>Snack:</strong> {{ plan.snack }}</li>
                    </ul>
                    <div class="mt-4 flex justify-end gap-2">
                        <a href="{{ url_for('download_diet_plan', result_id=plan.id) }}" class="btn btn-sm btn-success">Download PDF</a>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-center text-gray-600 text-lg">You haven't generated any diet plans yet. Go to the <a href="{{ url_for('diet_form_page') }}" class="text-success hover:underline">Diet Plan</a> page to create your first plan!</p>
        {% endif %}
    </div>
</section>

<!-- Footer -->
<footer class="bg-success text-white py-4 mt-auto">
    <div class="container mx-auto text-center">
        <p>Â© 2025 Design by Satkar Shrestha and Sandhya Gharti. All rights reserved.</p>
    </div>
</footer>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Show alert message (utility function)
    function showAlert(message, type) {
        const existingAlerts = document.querySelectorAll(".alert");
        existingAlerts.forEach((alert) => alert.remove());

        const alertDiv = document.createElement("div");
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.top = "20px";
        alertDiv.style.right = "20px";
        alertDiv.style.zIndex = "9999";
        alertDiv.style.minWidth = "300px";

        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);

        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Logout function (common action)
    function logout() {
        if (confirm("Are you sure you want to logout?")) {
            fetch("/api/logout", {
                method: "POST",
            })
            .then((response) => response.json())
            .then((data) => {
                if (data.success) {
                    window.location.href = "/";
                }
            })
            .catch((error) => {
                console.error("Logout error:", error);
                window.location.href = "/";
            });
        }
    }

    // Check authentication on page load
    document.addEventListener("DOMContentLoaded", () => {
        checkAuth();
    });

    // Check if user is authenticated (specific to diet history page)
    function checkAuth() {
        fetch("/api/auth-status")
            .then((response) => response.json())
            .then((data) => {
                if (!data.authenticated || data.user_type !== "user") {
                    window.location.href = "/"; // Redirect to index if not authenticated as user
                } else {
                    document.getElementById("username-display").textContent = data.user.first_name || data.user.username;
                    document.getElementById("username-display-dropdown").textContent = data.user.first_name || data.user.username;
                }
            })
            .catch((error) => {
                console.error("Auth check failed:", error);
                window.location.href = "/"; // Redirect on error
            });
    }
</script>
</body>
</html>
